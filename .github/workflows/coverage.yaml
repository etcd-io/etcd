name: Coverage
on: [push, pull_request]
jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: "1.17.6"
    - run: |
        export COVERDIR=$(readlink -f "./covdir")
        PASSES='unit_cov' ./test.sh
        TAG=unit ./scripts/codecov_merge.sh
    - uses: actions/upload-artifact@v2
      with:
        name: unit-coverage
        path: covdir/unit.coverprofile
  integration:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: "1.17.6"
    - run: |
        export COVERDIR=$(readlink -f "./covdir")
        PASSES='integration_cov' ./test.sh
        TAG=integration ./scripts/codecov_merge.sh
    - uses: actions/upload-artifact@v2
      with:
        name: integration-coverage
        path: covdir/integration.coverprofile
  e2e:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: "1.17.6"
    - run: |
        export COVERDIR=$(readlink -f "./covdir")
        PASSES='build build_cov e2e_cov' ./test.sh
        TAG=e2e ./scripts/codecov_merge.sh
    - uses: actions/upload-artifact@v2
      with:
        name: e2e-coverage
        path: covdir/e2e.coverprofile
  upload:
    needs:
    - unit
    - integration
    - e2e
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/download-artifact@v2
      with:
        name: unit-coverage
        path: covdir/unit.coverprofile
    - uses: actions/download-artifact@v2
      with:
        name: integration-coverage
        path: covdir/integration.coverprofile
    - uses: actions/download-artifact@v2
      with:
        name: e2e-coverage
        path: covdir/e2e.coverprofile
    - run: |
        export COVERDIR=$(readlink -f "./covdir")
        TAG=all ./scripts/codecov_merge.sh
        TAG=all ./scripts/codecov_upload.sh
