name: Coverage
on: [push, pull_request]
jobs:
  coverage:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
        - unit
        - integration
        - e2e
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: "1.17.6"
    - env:
        TARGET: ${{ matrix.target }}
      run: |
        export COVERDIR=$(readlink -f "./covdir")
        case "${TARGET}" in
          unit)
            PASSES='unit_cov' ./test.sh
            TAG=unit ./scripts/codecov_upload.sh
            ;;
          integration)
            PASSES='integration_cov' ./test.sh
            TAG=integration ./scripts/codecov_upload.sh
            ;;
          e2e)
            PASSES='build build_cov e2e_cov' ./test.sh
            TAG=e2e ./scripts/codecov_upload.sh
            ;;
          *)
            echo "Failed to find target"
            exit 1
            ;;
        esac
